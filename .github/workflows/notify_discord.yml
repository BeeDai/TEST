name: Notify Discord on Push

on:
  push:
    branches:
      - main

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Notify all pushed commits with single header and count (Skip Merge)
        shell: bash
        run: |
          # ã‚³ãƒŸãƒƒãƒˆæƒ…å ±å–å¾—
          commits='${{ toJson(github.event.commits) }}'
          actor='${{ github.actor }}'
          length=$(echo "$commits" | jq length)

          # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æœ¬æ–‡ã®åˆæœŸåŒ–ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ä»˜ãï¼‰
          content="# ğŸ“¢ GitHubã«PushãŒã‚ã‚Šã¾ã—ãŸï¼"

          # æœ‰åŠ¹ãªã‚³ãƒŸãƒƒãƒˆãŒã‚ã£ãŸã‹ã®ãƒ•ãƒ©ã‚°
          valid_commit_found=false

          # ã‚³ãƒŸãƒƒãƒˆç•ªå·ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼åˆæœŸåŒ–
          count=1

          # å„ã‚³ãƒŸãƒƒãƒˆã‚’ãƒ«ãƒ¼ãƒ—
          for i in $(seq 0 $((length - 1))); do
            iso_time=$(echo "$commits" | jq -r ".[$i].timestamp")
            formatted_time=$(TZ=Asia/Tokyo date -d "$iso_time" "+%Yå¹´%mæœˆ%dæ—¥%H:%M:%S")
            message=$(echo "$commits" | jq -r ".[$i].message" | sed 's/"/\\"/g')

            # Mergeã‚³ãƒŸãƒƒãƒˆã¯ã‚¹ã‚­ãƒƒãƒ—
            if echo "$message" | grep -qi '^Merge'; then
              continue
            fi

            # ç•ªå·ä»˜ãã§ã‚³ãƒŸãƒƒãƒˆæƒ…å ±ã‚’æœ¬æ–‡ã«è¿½è¨˜
            content="$content\n\## No.$count\n> ## ğŸ‘¤ by $actor\n> **ğŸ•’ $formatted_time**\n> ğŸ’¬ $message"

            # æœ‰åŠ¹ã‚³ãƒŸãƒƒãƒˆç™ºè¦‹ãƒ•ãƒ©ã‚°ON
            valid_commit_found=true

            # ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’å¢—ã‚„ã™
            count=$((count + 1))
          done

          # æœ‰åŠ¹ãªã‚³ãƒŸãƒƒãƒˆãŒã‚ã‚Œã°é€šçŸ¥
          if [ "$valid_commit_found" = true ]; then
            curl -X POST -H "Content-Type: application/json" \
              -d "{\"content\": \"$content\"}" \
              ${{ secrets.DISCORD_WEBHOOK }}
          fi
