name: Notify Discord on Push

on:
  push:
    branches:
      - main

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      # ã‚¹ãƒ†ãƒƒãƒ—1: å„Pushã•ã‚ŒãŸã‚³ãƒŸãƒƒãƒˆæƒ…å ±ã‚’å–å¾—ã—ã€é€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆ
      - name: Notify each pushed commit with formatted message (Skip Merge)
        shell: bash
        run: |
          # ã‚³ãƒŸãƒƒãƒˆæƒ…å ±ã‚’å–å¾—
          commits='${{ toJson(github.event.commits) }}'
          
          # ãƒ—ãƒƒã‚·ãƒ¥ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å–å¾—
          actor='${{ github.actor }}'
          
          # ã‚³ãƒŸãƒƒãƒˆæ•°ã‚’å–å¾—
          length=$(echo "$commits" | jq length)
          
          # å„ã‚³ãƒŸãƒƒãƒˆã‚’ãƒ«ãƒ¼ãƒ—å‡¦ç†
          for i in $(seq 0 $((length - 1))); do

            # ã‚³ãƒŸãƒƒãƒˆæ™‚åˆ»ã‚’ISOå½¢å¼ã§å–å¾—
            iso_time=$(echo "$commits" | jq -r ".[$i].timestamp")
            
            # æ—¥æœ¬æ™‚é–“ï¼ˆJSTï¼‰ã«å¤‰æ›ã—ã¦ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
            formatted_time=$(TZ=Asia/Tokyo date -d "$iso_time" "+%Yå¹´%mæœˆ%dæ—¥%H:%M:%S")
            
            # ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—ã—ã¦ã€ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
            message=$(echo "$commits" | jq -r ".[$i].message" | sed 's/"/\\"/g')

            # Mergeã‚³ãƒŸãƒƒãƒˆãªã‚‰ã‚¹ã‚­ãƒƒãƒ—ï¼ˆé€šçŸ¥ã—ãªã„ï¼‰
            if echo "$message" | grep -qi '^Merge'; then
              continue
            fi

            # Discordã«é€šçŸ¥ã‚’é€ä¿¡
            curl -X POST -H "Content-Type: application/json" \
              -d "{\"content\": \"# ğŸ“¢ GitHubã«PushãŒã‚ã‚Šã¾ã—ãŸï¼\n>>> ## ğŸ‘¤ by $actor\n\n**ğŸ•’  $formatted_time**\nğŸ’¬ $message\n\n\"}" \
              ${{ secrets.DISCORD_WEBHOOK }}

          done
